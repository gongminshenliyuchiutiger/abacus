<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>超級神珠心算盤練習系統</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: 'Segoe UI', 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #e6ecf0, #c9d6df);
            margin: 0;
            padding: 2rem;
            overflow-x: hidden;
            touch-action: manipulation;
        }
        h1 {
            color: #34495e;
            font-size: clamp(1.8rem, 5vw, 2.8rem);
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            letter-spacing: 1px;
            animation: fadeIn 1s ease-in;
        }
        .control-panel {
            margin-bottom: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        .abacus {
            padding: 1.5rem;
            border-radius: 1.5rem;
            border: 0.5rem solid;
            box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.25), inset 0 0.1rem 0.3rem rgba(255, 255, 255, 0.2);
            position: relative;
            display: flex;
            justify-content: center;
            width: 100%;
            max-width: 60rem;
            min-width: 20rem;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }
        .abacus.theme-classic {
            background: linear-gradient(to bottom, #6d4c41, #4e342e);
            border-color: #3e2723;
        }
        .abacus.theme-modern {
            background: linear-gradient(to bottom, #2c3e50, #1a252f);
            border-color: #17202a;
        }
        .abacus.theme-bright {
            background: linear-gradient(to bottom, #f1c40f, #e67e22);
            border-color: #d35400;
        }
        .abacus.theme-cyberpunk {
            background: linear-gradient(to bottom, #0f1419, #1c2526);
            border-color: #00ffcc;
            box-shadow: 0 0 1rem rgba(0, 255, 204, 0.5);
        }
        .abacus.theme-forest {
            background: linear-gradient(to bottom, #2f4f4f, #1e2f23);
            border-color: #556b2f;
        }
        .column {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            width: clamp(2rem, 4vw, 2.5rem);
            margin: 0 0.3rem;
        }
        .bead {
            width: clamp(1.5rem, 3vw, 1.8rem);
            height: clamp(1rem, 2vw, 1.2rem);
            border-radius: 0.6rem;
            margin: 0.3rem auto;
            cursor: pointer;
            transition: transform 0.3s ease, background 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 0.2rem 0.4rem rgba(0, 0, 0, 0.2);
            touch-action: none;
        }
        .abacus.theme-classic .bead {
            background: linear-gradient(135deg, #ffca28, #ffa000);
            border: 0.1rem solid #e65100;
        }
        .abacus.theme-modern .bead {
            background: linear-gradient(135deg, #3498db, #2980b9);
            border: 0.1rem solid #1f618d;
        }
        .abacus.theme-bright .bead {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            border: 0.1rem solid #1b5e20;
        }
        .abacus.theme-cyberpunk .bead {
            background: linear-gradient(135deg, #ff00cc, #00ffcc);
            border: 0.1rem solid #ff00ff;
        }
        .abacus.theme-forest .bead {
            background: linear-gradient(135deg, #8fbc8f, #556b2f);
            border: 0.1rem solid #2e8b57;
        }
        .bead:hover {
            box-shadow: 0 0.3rem 0.6rem rgba(0, 0, 0, 0.3), 0 0 0.3rem rgba(255, 165, 0, 0.5);
        }
        .bead.active {
            box-shadow: 0 0.3rem 0.8rem rgba(0, 0, 0, 0.3), 0 0 0.5rem rgba(255, 87, 34, 0.6);
        }
        .abacus.theme-classic .bead.active {
            background: linear-gradient(135deg, #ff5722, #d81b60);
            border-color: #b71c1c;
        }
        .abacus.theme-modern .bead.active {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            border-color: #6c3483;
        }
        .abacus.theme-bright .bead.active {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border-color: #962626;
        }
        .abacus.theme-cyberpunk .bead.active {
            background: linear-gradient(135deg, #ff9900, #ff00ff);
            border-color: #ff6600;
        }
        .abacus.theme-forest .bead.active {
            background: linear-gradient(135deg, #cd853f, #8b4513);
            border-color: #6b3a0d;
        }
        .bead.top.active {
            transform: translateY(0.8rem);
        }
        .bead.bottom.active {
            transform: translateY(-0.8rem);
        }
        .beam {
            width: 100%;
            height: 0.8rem;
            margin: 0.5rem 0;
            border-radius: 0.2rem;
            box-shadow: inset 0 0.05rem 0.1rem rgba(0, 0, 0, 0.3);
        }
        .abacus.theme-classic .beam {
            background: #3e2723;
        }
        .abacus.theme-modern .beam {
            background: #17202a;
        }
        .abacus.theme-bright .beam {
            background: #d35400;
        }
        .abacus.theme-cyberpunk .beam {
            background: #00ffcc;
        }
        .abacus.theme-forest .beam {
            background: #556b2f;
        }
        .value {
            color: #eceff1;
            font-weight: bold;
            font-size: clamp(0.8rem, 2vw, 1rem);
            margin-top: 0.5rem;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }
        .practice-panel {
            margin-top: 1rem;
            text-align: center;
            display: none;
            width: 100%;
            max-width: 60rem;
        }
        .difficulty-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            margin: 0.5rem 0;
        }
        .difficulty-levels {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
        }
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        .prompt-area {
            margin-top: 1rem;
            padding: 1rem;
            background: #fff;
            border-radius: 1rem;
            box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 60rem;
            text-align: center;
            display: none;
            animation: slideUp 0.5s ease-out;
        }
        #practice-question {
            font-size: clamp(1rem, 3vw, 1.4rem);
            color: #263238;
            font-weight: 500;
            margin-bottom: 1rem;
        }
        #feedback {
            font-size: clamp(0.9rem, 2.5vw, 1.3rem);
            padding: 0.8rem;
            border-radius: 0.8rem;
            transition: all 0.3s ease;
        }
        #feedback:empty {
            display: none;
        }
        button {
            padding: 0.6rem 1rem;
            margin: 0.3rem;
            font-size: clamp(0.8rem, 2vw, 1rem);
            cursor: pointer;
            border: none;
            border-radius: 1.5rem;
            background: linear-gradient(135deg, #42a5f5, #1e88e5);
            color: #fff;
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 0.2rem 0.8rem rgba(0, 0, 0, 0.15);
        }
        button:hover {
            background: linear-gradient(135deg, #1e88e5, #1565c0);
            transform: translateY(-0.2rem);
            box-shadow: 0 0.4rem 1rem rgba(0, 0, 0, 0.2);
        }
        .control-panel button.active {
            background: linear-gradient(135deg, #1976d2, #0d47a1);
            transform: translateY(-0.2rem);
            box-shadow: 0 0.4rem 1rem rgba(0, 0, 0, 0.25);
        }
        #reset-button {
            position: absolute;
            top: -2.5rem;
            right: 1rem;
            background: linear-gradient(135deg, #4caf50, #388e3c);
            font-size: clamp(0.9rem, 2vw, 1.1rem);
            padding: 0.5rem 0.8rem;
            border-radius: 1.2rem;
            display: flex;
            align-items: center;
            border: 2px solid #fff;
        }
        #reset-button:hover {
            background: linear-gradient(135deg, #388e3c, #2e7d32);
            transform: scale(1.1);
            box-shadow: 0 0.4rem 1rem rgba(0, 0, 0, 0.3);
            border: 2px solid #fff;
        }
        .difficulty-levels button {
            width: clamp(2rem, 5vw, 2.5rem);
            height: clamp(2rem, 5vw, 2.5rem);
            padding: 0;
            border-radius: 50%;
            font-size: clamp(0.8rem, 2vw, 1rem);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .difficulty-levels button.active {
            transform: scale(1.2);
            box-shadow: 0 0 0.6rem rgba(255, 255, 255, 0.8), 0 0 1rem rgba(255, 105, 180, 0.6), 0 0 1.5rem rgba(255, 69, 0, 0.4);
        }
        .difficulty-levels button:nth-child(1) { background: linear-gradient(135deg, #b3e5fc, #81d4fa); }
        .difficulty-levels button:nth-child(1):hover, .difficulty-levels button:nth-child(1).active:hover { background: linear-gradient(135deg, #81d4fa, #4fc3f7); }
        .difficulty-levels button:nth-child(2) { background: linear-gradient(135deg, #b2ebf2, #80deea); }
        .difficulty-levels button:nth-child(2):hover, .difficulty-levels button:nth-child(2).active:hover { background: linear-gradient(135deg, #80deea, #4dd0e1); }
        .difficulty-levels button:nth-child(3) { background: linear-gradient(135deg, #b9f6ca, #76ff03); }
        .difficulty-levels button:nth-child(3):hover, .difficulty-levels button:nth-child(3).active:hover { background: linear-gradient(135deg, #76ff03, #64dd17); }
        .difficulty-levels button:nth-child(4) { background: linear-gradient(135deg, #ccff90, #aeea00); }
        .difficulty-levels button:nth-child(4):hover, .difficulty-levels button:nth-child(4).active:hover { background: linear-gradient(135deg, #aeea00, #c6ff00); }
        .difficulty-levels button:nth-child(5) { background: linear-gradient(135deg, #fff59d, #fdd835); }
        .difficulty-levels button:nth-child(5):hover, .difficulty-levels button:nth-child(5).active:hover { background: linear-gradient(135deg, #fdd835, #fbc02d); }
        .difficulty-levels button:nth-child(6) { background: linear-gradient(135deg, #ffe082, #ffb300); }
        .difficulty-levels button:nth-child(6):hover, .difficulty-levels button:nth-child(6).active:hover { background: linear-gradient(135deg, #ffb300, #ffa000); }
        .difficulty-levels button:nth-child(7) { background: linear-gradient(135deg, #ffcc80, #ff9100); }
        .difficulty-levels button:nth-child(7):hover, .difficulty-levels button:nth-child(7).active:hover { background: linear-gradient(135deg, #ff9100, #ff6d00); }
        .difficulty-levels button:nth-child(8) { background: linear-gradient(135deg, #ffab91, #ff5722); }
        .difficulty-levels button:nth-child(8):hover, .difficulty-levels button:nth-child(8).active:hover { background: linear-gradient(135deg, #ff5722, #f4511e); }
        .difficulty-levels button:nth-child(9) { background: linear-gradient(135deg, #ef9a9a, #f44336); }
        .difficulty-levels button:nth-child(9):hover, .difficulty-levels button:nth-child(9).active:hover { background: linear-gradient(135deg, #f44336, #e53935); }
        .difficulty-levels button:nth-child(10) { background: linear-gradient(135deg, #f06292, #d81b60); }
        .difficulty-levels button:nth-child(10):hover, .difficulty-levels button:nth-child(10).active:hover { background: linear-gradient(135deg, #d81b60, #c2185b); }
        .action-buttons button {
            padding: 0.6rem 1rem;
            font-size: clamp(0.8rem, 2vw, 1rem);
            border-radius: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        .action-buttons button:nth-child(1) { background: linear-gradient(135deg, #42a5f5, #1e88e5); }
        .action-buttons button:nth-child(1):hover { background: linear-gradient(135deg, #1e88e5, #1565c0); }
        .action-buttons button:nth-child(2) { background: linear-gradient(135deg, #42a5f5, #1e88e5); }
        .action-buttons button:nth-child(2):hover { background: linear-gradient(135deg, #1e88e5, #1565c0); }
        .theme-selector {
            margin: 1rem 0;
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .theme-selector button {
            padding: 0.5rem 0.8rem;
            font-size: clamp(0.7rem, 1.8vw, 0.9rem);
            border-radius: 1.2rem;
            border: none;
            color: #fff;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .theme-selector button.theme-classic {
            background: linear-gradient(135deg, #8d5524, #6d4c41);
        }
        .theme-selector button.theme-classic:hover {
            background: linear-gradient(135deg, #6d4c41, #4e342e);
            transform: scale(1.05);
        }
        .theme-selector button.theme-modern {
            background: linear-gradient(135deg, #34495e, #2c3e50);
        }
        .theme-selector button.theme-modern:hover {
            background: linear-gradient(135deg, #2c3e50, #1a252f);
            transform: scale(1.05);
        }
        .theme-selector button.theme-bright {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }
        .theme-selector button.theme-bright:hover {
            background: linear-gradient(135deg, #e67e22, #d35400);
            transform: scale(1.05);
        }
        .theme-selector button.theme-cyberpunk {
            background: linear-gradient(135deg, #ff00cc, #00ffcc);
        }
        .theme-selector button.theme-cyberpunk:hover {
            background: linear-gradient(135deg, #ff00ff, #00ccff);
            transform: scale(1.05);
        }
        .theme-selector button.theme-forest {
            background: linear-gradient(135deg, #8fbc8f, #556b2f);
        }
        .theme-selector button.theme-forest:hover {
            background: linear-gradient(135deg, #556b2f, #2e8b57);
            transform: scale(1.05);
        }
        .footer {
            margin-top: 2rem;
            color: #95a5a6;
            font-size: clamp(0.7rem, 1.5vw, 0.9rem);
            text-align: center;
            letter-spacing: 0.5px;
        }
        .floating-ball {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            width: 3rem;
            height: 3rem;
            background: linear-gradient(135deg, #ffca28, #ffa000);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: move;
            box-shadow: 0 0.2rem 0.5rem rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        .floating-ball:hover {
            transform: scale(1.1);
        }
        .floating-ball i {
            font-size: 1.5rem;
            color: #fff;
        }
        .modal {
            display: none;
            position: fixed;
            width: 20rem;
            max-width: 90%;
            background: #fff;
            border-radius: 1rem;
            box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.3);
            z-index: 2000;
            cursor: move;
            padding: 1rem;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #ddd;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 1.2rem;
            color: #34495e;
        }
        .modal-header .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        .modal-content {
            max-height: 20rem;
            overflow-y: auto;
            padding: 1rem 0;
            font-size: 1rem;
            color: #263238;
        }
        .modal-content h3 {
            margin: 0.5rem 0;
            color: #34495e;
        }
        .modal-content p {
            margin: 0.3rem 0;
        }
        .resize-handle {
            position: absolute;
            bottom: 0.5rem;
            right: 0.5rem;
            width: 1rem;
            height: 1rem;
            background: #ccc;
            border-radius: 50%;
            cursor: se-resize;
        }
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            .abacus {
                padding: 1rem;
            }
            .column {
                width: clamp(1.5rem, 3.5vw, 2rem);
                margin: 0 0.2rem;
            }
            .bead {
                width: clamp(1.2rem, 2.8vw, 1.5rem);
                height: clamp(0.8rem, 1.8vw, 1rem);
            }
            .beam {
                height: 0.6rem;
            }
            button {
                padding: 0.5rem 0.8rem;
            }
            .difficulty-levels {
                gap: 0.3rem;
            }
            .action-buttons {
                gap: 0.5rem;
            }
            .floating-ball {
                width: 2.5rem;
                height: 2.5rem;
            }
            .floating-ball i {
                font-size: 1.2rem;
            }
        }
        @media (max-width: 480px) {
            h1 {
                font-size: clamp(1.5rem, 4vw, 2rem);
            }
            .control-panel {
                flex-direction: column;
                align-items: center;
            }
            .abacus {
                padding: 0.8rem;
            }
            .column {
                width: clamp(1.2rem, 3vw, 1.5rem);
            }
            .bead {
                width: clamp(1rem, 2.5vw, 1.2rem);
                height: clamp(0.6rem, 1.5vw, 0.8rem);
            }
            .difficulty-levels button {
                width: clamp(1.8rem, 4vw, 2rem);
                height: clamp(1.8rem, 4vw, 2rem);
            }
            #reset-button {
                top: -2rem;
                right: 0.5rem;
            }
            .action-buttons {
                flex-direction: column;
                gap: 0.3rem;
            }
            .modal {
                width: 18rem;
            }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(1rem); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <h1>超級神珠心算盤練習系統</h1>
    <div class="control-panel">
        <button id="free-mode" onclick="switchMode('free')"><i class="fas fa-hand-pointer"></i> 自由模式</button>
        <button id="practice-mode" onclick="switchMode('practice')"><i class="fas fa-calculator"></i> 練習模式</button>
    </div>
    <div class="abacus theme-classic" id="abacus">
        <button id="reset-button" onclick="abacus.reset()" title="全部歸零">
            <i class="fas fa-undo"></i> 歸零
        </button>
    </div>
    <div class="theme-selector">
        <button class="theme-classic" onclick="switchTheme('classic')">經典木質</button>
        <button class="theme-modern" onclick="switchTheme('modern')">現代黑藍</button>
        <button class="theme-bright" onclick="switchTheme('bright')">明亮橙黃</button>
        <button class="theme-cyberpunk" onclick="switchTheme('cyberpunk')">賽博龐克</button>
        <button class="theme-forest" onclick="switchTheme('forest')">田園森林</button>
    </div>
    <div class="practice-panel" id="practice-panel">
        <div class="difficulty-buttons">
            <div class="difficulty-levels">
                <span style="margin-right: 0.5rem; font-size: clamp(1rem, 2.5vw, 1.2rem); color: #34495e;"><i class="fas fa-level-up-alt"></i> 請選擇難度：</span>
                <button onclick="selectDifficulty(1)">1</button>
                <button onclick="selectDifficulty(2)">2</button>
                <button onclick="selectDifficulty(3)">3</button>
                <button onclick="selectDifficulty(4)">4</button>
                <button onclick="selectDifficulty(5)">5</button>
                <button onclick="selectDifficulty(6)">6</button>
                <button onclick="selectDifficulty(7)">7</button>
                <button onclick="selectDifficulty(8)">8</button>
                <button onclick="selectDifficulty(9)">9</button>
                <button onclick="selectDifficulty(10)">10</button>
            </div>
            <div class="action-buttons">
                <button onclick="checkAnswer()"><i class="fas fa-check"></i> 檢查答案</button>
                <button onclick="nextQuestion()"><i class="fas fa-arrow-right"></i> 下一題</button>
            </div>
        </div>
    </div>
    <div class="prompt-area" id="prompt-area">
        <div id="practice-question"></div>
        <div id="feedback"></div>
    </div>
    <div class="floating-ball" id="floating-ball">
        <i class="fas fa-book"></i>
    </div>
    <div class="modal" id="modal">
        <div class="modal-header">
            <h2><i class="fas fa-book"></i> 算盤講義</h2>
            <button class="close-btn" onclick="closeModal()">×</button>
        </div>
        <div class="modal-content">
            <h3>認識算盤</h3>
            <p>上珠：5 / 下珠：1</p>
            <h3>算盤指法</h3>
            <p>加一二三四：拇指</p>
            <p>減一二三四：食指</p>
            <p>加五減五：食指</p>
            <p>六七八九：用兩指</p>
            <h3>10的組合</h3>
            <p><strong>加法口訣 (減補數加10)</strong></p>
            <p>+9 = -1 + 10</p>
            <p>+8 = -2 + 10</p>
            <p>+7 = -3 + 10</p>
            <p>+6 = -4 + 10</p>
            <p>+5 = -5 + 10</p>
            <p>+4 = -6 + 10</p>
            <p>+3 = -7 + 10</p>
            <p>+2 = -8 + 10</p>
            <p>+1 = -9 + 10</p>
            <p><strong>減法口訣 (減10加補數)</strong></p>
            <p>-9 = -10 + 1</p>
            <p>-8 = -10 + 2</p>
            <p>-7 = -10 + 3</p>
            <p>-6 = -10 + 4</p>
            <p>-5 = -10 + 5</p>
            <p>-4 = -10 + 6</p>
            <p>-3 = -10 + 7</p>
            <p>-2 = -10 + 8</p>
            <p>-1 = -10 + 9</p>
            <h3>5的組合</h3>
            <p><strong>加法口訣 (減補數加5)</strong></p>
            <p>+4 = -1 + 5</p>
            <p>+3 = -2 + 5</p>
            <p>+2 = -3 + 5</p>
            <p>+1 = -4 + 5</p>
            <p><strong>減法口訣 (減5加補數)</strong></p>
            <p>-4 = -5 + 1</p>
            <p>-3 = -5 + 2</p>
            <p>-2 = -5 + 3</p>
            <p>-1 = -5 + 4</p>
        </div>
        <div class="resize-handle" id="resize-handle"></div>
    </div>
    <div class="footer">Copyright © Liyuchiutiger Gongminshen</div>

    <script>
        document.title = "超級神珠心算盤練習系統";

        class Abacus {
            constructor(columns = 15) {
                this.columns = columns;
                this.values = new Array(columns).fill(0);
                this.render();
                this.addTouchEvents();
            }

            render() {
                const abacusDiv = document.getElementById('abacus');
                const resetButton = abacusDiv.querySelector('#reset-button');
                const currentTheme = abacusDiv.className.split(' ').find(cls => cls.startsWith('theme-')) || 'theme-classic';
                abacusDiv.innerHTML = '';
                if (resetButton) abacusDiv.appendChild(resetButton);

                for (let i = 0; i < this.columns; i++) {
                    const columnDiv = document.createElement('div');
                    columnDiv.className = 'column';

                    const topBead = document.createElement('div');
                    topBead.className = 'bead top';
                    topBead.dataset.value = 5;
                    topBead.dataset.position = 'top';
                    topBead.dataset.index = i;
                    topBead.addEventListener('click', () => this.toggleTopBead(i));
                    columnDiv.appendChild(topBead);

                    const beam = document.createElement('div');
                    beam.className = 'beam';
                    columnDiv.appendChild(beam);

                    for (let j = 0; j < 4; j++) {
                        const bead = document.createElement('div');
                        bead.className = 'bead bottom';
                        bead.dataset.value = 1;
                        bead.dataset.position = 'bottom';
                        bead.dataset.index = i;
                        bead.dataset.beadIndex = j;
                        bead.addEventListener('click', () => this.toggleBottomBead(i, j));
                        columnDiv.appendChild(bead);
                    }

                    const valueDiv = document.createElement('div');
                    valueDiv.className = 'value';
                    valueDiv.textContent = '0';
                    columnDiv.appendChild(valueDiv);

                    abacusDiv.appendChild(columnDiv);
                }
                abacusDiv.className = `abacus ${currentTheme}`;
            }

            addTouchEvents() {
                const beads = document.querySelectorAll('.bead');
                beads.forEach(bead => {
                    bead.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        this.handleTouch(e);
                    });
                    bead.addEventListener('touchmove', (e) => {
                        e.preventDefault();
                        this.handleTouch(e);
                    });
                    bead.addEventListener('touchend', (e) => {
                        e.preventDefault();
                    });
                });
            }

            handleTouch(event) {
                const touches = event.touches;
                for (let i = 0; i < touches.length; i++) {
                    const touch = touches[i];
                    const bead = document.elementFromPoint(touch.clientX, touch.clientY);
                    if (bead && bead.classList.contains('bead')) {
                        const column = parseInt(bead.dataset.index);
                        if (bead.dataset.position === 'top') {
                            this.toggleTopBead(column);
                        } else if (bead.dataset.position === 'bottom') {
                            const beadIndex = parseInt(bead.dataset.beadIndex);
                            this.toggleBottomBead(column, beadIndex);
                        }
                    }
                }
            }

            toggleTopBead(column) {
                const columnDiv = document.querySelectorAll('.column')[column];
                const topBead = columnDiv.querySelector('.bead.top');
                if (topBead.classList.contains('active')) {
                    topBead.classList.remove('active');
                    this.values[column] -= 5;
                } else {
                    topBead.classList.add('active');
                    this.values[column] += 5;
                }
                this.updateValue(column);
            }

            toggleBottomBead(column, beadIndex) {
                const columnDiv = document.querySelectorAll('.column')[column];
                const bottomBeads = columnDiv.querySelectorAll('.bead.bottom');
                const clickedBead = bottomBeads[beadIndex];
                let currentValue = this.values[column] % 5;
                let targetIndex = beadIndex;

                if (clickedBead.classList.contains('active')) {
                    bottomBeads.forEach((bead, index) => {
                        if (index >= targetIndex) bead.classList.remove('active');
                    });
                    this.values[column] -= (currentValue - targetIndex);
                } else {
                    bottomBeads.forEach((bead, index) => {
                        if (index <= targetIndex) bead.classList.add('active');
                        else bead.classList.remove('active');
                    });
                    this.values[column] = this.values[column] - currentValue + (targetIndex + 1);
                }
                this.updateValue(column);
            }

            updateValue(column) {
                const columnDiv = document.querySelectorAll('.column')[column];
                const valueDiv = columnDiv.querySelector('.value');
                valueDiv.textContent = this.values[column];
            }

            reset() {
                this.values.fill(0);
                document.querySelectorAll('.bead').forEach(bead => bead.classList.remove('active'));
                document.querySelectorAll('.value').forEach(value => value.textContent = '0');
            }

            getTotal() {
                return this.values.reduce((sum, val, idx) => sum + val * Math.pow(10, this.columns - 1 - idx), 0);
            }
        }

        const abacus = new Abacus();
        let currentMode = 'free';
        let currentPracticeType = 'calculation';
        let currentQuestion = null;
        let difficulty = 0;

        function switchMode(mode) {
            currentMode = mode;
            const practicePanel = document.getElementById('practice-panel');
            const promptArea = document.getElementById('prompt-area');
            const freeButton = document.getElementById('free-mode');
            const practiceButton = document.getElementById('practice-mode');

            freeButton.classList.remove('active');
            practiceButton.classList.remove('active');

            if (mode === 'free') {
                freeButton.classList.add('active');
                practicePanel.style.display = 'none';
                promptArea.style.display = 'none';
                abacus.reset();
            } else if (mode === 'practice') {
                practiceButton.classList.add('active');
                practicePanel.style.display = 'block';
                promptArea.style.display = 'none';
                document.getElementById('practice-question').textContent = '';
                document.getElementById('feedback').textContent = '';
                difficulty = 0;
                abacus.reset();
                clearDifficultySelection();
            }
        }

        function switchTheme(theme) {
            const abacusDiv = document.getElementById('abacus');
            abacusDiv.className = `abacus theme-${theme}`;
            abacus.render();
        }

        function selectDifficulty(level) {
            difficulty = level;
            clearDifficultySelection();
            const selectedButton = document.querySelector(`.difficulty-levels button:nth-child(${level + 1})`);
            selectedButton.classList.add('active');
            nextQuestion();
        }

        function clearDifficultySelection() {
            const buttons = document.querySelectorAll('.difficulty-levels button');
            buttons.forEach(button => button.classList.remove('active'));
        }

        function nextQuestion() {
            if (currentMode !== 'practice' || difficulty === 0) return;
            abacus.reset();
            const questionDiv = document.getElementById('practice-question');
            const feedbackDiv = document.getElementById('feedback');
            const promptArea = document.getElementById('prompt-area');
            feedbackDiv.textContent = '';
            promptArea.style.display = 'block';

            const maxNum = Math.pow(10, Math.ceil(difficulty / 2)) - 1;
            const num1 = Math.floor(Math.random() * maxNum) + 1;
            const num2 = Math.floor(Math.random() * maxNum) + 1;
            const operator = difficulty > 5 && Math.random() > 0.5 ? '-' : '+';
            if (operator === '-') {
                currentQuestion = num1 >= num2 ? num1 - num2 : num2 - num1;
                questionDiv.textContent = `(難度 ${difficulty}) 請計算：${Math.max(num1, num2)} - ${Math.min(num1, num2)} =`;
            } else {
                currentQuestion = num1 + num2;
                questionDiv.textContent = `(難度 ${difficulty}) 請計算：${num1} + ${num2} =`;
            }
        }

        function checkAnswer() {
            if (currentMode !== 'practice' || !currentQuestion) return;
            const total = abacus.getTotal();
            const feedbackDiv = document.getElementById('feedback');
            if (total === currentQuestion) {
                feedbackDiv.textContent = '正確！';
                feedbackDiv.style.color = '#2e7d32';
                feedbackDiv.style.background = '#e8f5e9';
            } else {
                feedbackDiv.textContent = `錯誤，正確答案是 ${currentQuestion}`;
                feedbackDiv.style.color = '#c62828';
                feedbackDiv.style.background = '#ffebee';
            }
        }

        const floatingBall = document.getElementById('floating-ball');
        const modal = document.getElementById('modal');
        let isDraggingBall = false;
        let isDraggingModal = false;
        let isResizing = false;
        let ballOffsetX, ballOffsetY, modalOffsetX, modalOffsetY;

        floatingBall.addEventListener('mousedown', startDraggingBall);
        floatingBall.addEventListener('touchstart', startDraggingBall);
        floatingBall.addEventListener('click', openModal);

        document.addEventListener('mousemove', dragElement);
        document.addEventListener('touchmove', dragElement);
        document.addEventListener('mouseup', stopDragging);
        document.addEventListener('touchend', stopDragging);

        modal.querySelector('.modal-header').addEventListener('mousedown', startDraggingModal);
        modal.querySelector('.modal-header').addEventListener('touchstart', startDraggingModal);
        modal.querySelector('#resize-handle').addEventListener('mousedown', startResizing);
        modal.querySelector('#resize-handle').addEventListener('touchstart', startResizing);

        function startDraggingBall(e) {
            e.preventDefault();
            isDraggingBall = true;
            const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
            const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
            ballOffsetX = clientX - floatingBall.offsetLeft;
            ballOffsetY = clientY - floatingBall.offsetTop;
        }

        function startDraggingModal(e) {
            e.preventDefault();
            isDraggingModal = true;
            const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
            const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
            modalOffsetX = clientX - (parseFloat(modal.style.left) || 0);
            modalOffsetY = clientY - (parseFloat(modal.style.top) || 0);
        }

        function startResizing(e) {
            e.preventDefault();
            isResizing = true;
        }

        function dragElement(e) {
            e.preventDefault();
            const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
            const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;

            if (isDraggingBall) {
                floatingBall.style.left = `${clientX - ballOffsetX}px`;
                floatingBall.style.top = `${clientY - ballOffsetY}px`;
                floatingBall.style.bottom = 'auto';
                floatingBall.style.right = 'auto';
            } else if (isDraggingModal) {
                modal.style.left = `${clientX - modalOffsetX}px`;
                modal.style.top = `${clientY - modalOffsetY}px`;
            } else if (isResizing) {
                const newWidth = clientX - modal.offsetLeft + 10;
                const newHeight = clientY - modal.offsetTop + 10;
                modal.style.width = `${Math.max(200, newWidth)}px`;
                modal.style.maxWidth = '90%';
                modal.querySelector('.modal-content').style.maxHeight = `${Math.max(200, newHeight - 60)}px`;
            }
        }

        function stopDragging() {
            isDraggingBall = false;
            isDraggingModal = false;
            isResizing = false;
        }

        function openModal() {
            if (!isDraggingBall) {
                modal.style.display = 'block';
                if (!modal.style.left || !modal.style.top) {
                    const windowWidth = window.innerWidth;
                    const windowHeight = window.innerHeight;
                    const modalWidth = modal.offsetWidth;
                    const modalHeight = modal.offsetHeight;
                    modal.style.left = `${(windowWidth - modalWidth) / 2}px`;
                    modal.style.top = `${(windowHeight - modalHeight) / 2}px`;
                }
            }
        }

        function closeModal() {
            modal.style.display = 'none';
        }

        switchMode('free');
    </script>
</body>
</html>